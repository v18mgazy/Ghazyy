import React, { useEffect, useState } from 'react';
import { Bot, X, Smile, AlertTriangle } from 'lucide-react';
import { onValue, ref } from 'firebase/database';
import { motion } from 'framer-motion';
import { Button } from '@/components/ui/button';
import { Card } from '@/components/ui/card';
import { database } from '@/lib/firebase';

const SmartAssistant = () => {
  const [open, setOpen] = useState(false);
  const [report, setReport] = useState<any>(null);
  const [products, setProducts] = useState<any[]>([]);
  const [tip, setTip] = useState('');

  useEffect(() => {
    // تقرير الفواتير
    onValue(ref(database, 'invoices'), snapshot => {
      const invoicesData = snapshot.val();
      if (invoicesData) {
        const all = Object.values(invoicesData);
        const totalSales = all.reduce((acc: number, item: any) => acc + (item.total || 0), 0);
        const orders = all.length;
        const profit = all.reduce((acc: number, item: any) => acc + ((item.total || 0) - (item.cost || 0)), 0);
        setReport({ sales: totalSales, orders, profit });
      }
    });

    // المنتجات
    onValue(ref(database, 'products'), snapshot => {
      const data = snapshot.val();
      if (data) {
        setProducts(Object.values(data));
      }
    });

    // نصيحة اليوم
    const tips = [
      "راقب المنتجات الأكثر مبيعًا وجدّد مخزونها مبكرًا.",
        "اعرض خصومات على المنتجات البطيئة في الحركة.",
        "راجع تقارير المبيعات كل صباح لتحديد اتجاهات السوق.",
        "جرّب ترويج منتج مختلف كل أسبوع لزيادة التفاعل.",
        "احرص على توثيق الملاحظات من العملاء لتحسين تجربة الشراء.",
        "استخدم صورًا واضحة وجذابة لعرض المنتجات.",
        "تابع العملاء الذين لم يشتروا منذ فترة بعروض خاصة.",
        "قدّم هدية رمزية للعملاء المميزين.",
        "قلل من تنقل الزبون بين الصفحات لزيادة إتمام الشراء.",
        "راقب تعليقات العملاء على السوشيال ميديا باستمرار.",
        "احرص على تسعير المنتجات بناءً على السوق والمنافسين.",
        "وفر خيارات دفع متعددة لتسهيل الشراء.",
        "نظّم مسابقة بسيطة لزيادة التفاعل على الصفحة.",
        "تابع أداء الموظفين وشجعهم برسائل تحفيزية.",
        "اعرض تقييمات وآراء العملاء في الواجهة.",
        "نظّم المخزون شهريًا وتخلص من المنتجات الراكدة.",
        "اعرض منتج الأسبوع بعرض خاص مؤقت.",
        "أضف وصفًا مختصرًا وواضحًا لكل منتج.",
        "اضبط أوقات الرد على رسائل العملاء بانتظام.",
        "تابع إشعارات النظام أولًا بأول.",
        "استخدم الألوان المتناسقة في تصميم المتجر.",
        "أضف قسم 'المنتجات الأكثر طلبًا'.",
        "اختبر الصفحة على الهاتف باستمرار.",
        "استخدم كلمات بسيطة وواضحة في الإعلانات.",
        "استثمر في تحسين تجربة الشراء.",
        "استخدم صور العملاء وهم يستخدمون المنتج.",
        "تابع العائد على الإعلانات (ROAS).",
        "قسّم المنتجات حسب الفئات ليسهل البحث.",
        "أضف سياسة استرجاع مرنة.",
        "احرص على الأمان الإلكتروني للمتجر.",
        "أرسل رسالة ترحيبية تلقائية للعملاء الجدد.",
        "وفر الشحن المجاني عند حد معين.",
        "اعرض العروض في البانر بشكل مباشر.",
        "اعتمد على بيانات حقيقية لاتخاذ القرارات.",
        "استخدم التقارير اليومية لمراقبة النمو.",
        "جرّب حملات محدودة الزمن لتحفيز الشراء.",
        "أضف خانة ملاحظات في صفحة الطلب.",
        "اسأل العملاء عن تجربتهم بعد الشراء.",
        "تابع المنتجات الأكثر إرجاعًا وحلل الأسباب.",
        "استخدم فيديوهات قصيرة لعرض المنتجات.",
        "استفد من مواسم العيد والعروض.",
        "حدد هدف مبيعات أسبوعي لفريقك.",
        "اعرض المنتجات التي تم مشاهدتها مؤخرًا.",
        "ركّز على مميزات المنتج وليس فقط السعر.",
        "تابع Google Trends للمجال الخاص بك.",
        "استخدم اختبارات A/B لحملاتك.",
        "وفر رقم واتساب واضح للدعم.",
        "تابع ساعات الذروة في الطلب.",
        "شارك القصص الملهمة لعملائك.",
        "تابع تعليقات المنافسين وتعلم منها.",
        "حدث المحتوى بشكل دوري.",
        "أظهر عدد القطع المتبقية لتحفيز الشراء.",
        "قلل من عدد خطوات إتمام الشراء.",
        "اجعل صور المنتجات قابلة للتكبير.",
        "أضف مراجعات حقيقية من العملاء.",
        "استخدم أدوات إدارة الوقت للفريق.",
        "خصص مساحة في الصفحة للعروض اليومية.",
        "تابع مستوى رضا العملاء عبر استبيانات.",
        "درّب الموظفين على خدمة العملاء.",
        "استخدم الرموز التعبيرية لجذب الانتباه.",
        "أضف عداد تنازلي للعروض المؤقتة.",
        "اجعل الشحن مجاني في المناسبات.",
        "اختبر نظام التنبيهات داخل النظام.",
        "تابع العملاء النشطين وقدم لهم عروضًا.",
        "اعرض أحدث المنتجات دائمًا في الأعلى.",
        "أضف فيديو ترحيبي لواجهة المتجر.",
        "اجعل الروابط قصيرة وسهلة المشاركة.",
        "قسم الفواتير حسب الحالة لسهولة المراجعة.",
        "راجع أداء الإعلانات كل 3 أيام.",
        "احتفظ بنسخة احتياطية من قاعدة البيانات.",
        "حدث التطبيق بشكل دوري.",
        "اختبر صفحة الدفع من أجهزة مختلفة.",
        "احرص على سرعة تحميل التطبيق.",
        "أضف كود خصم للطلب الأول.",
        "حلل المبيعات حسب الفئة الزمنية.",
        "حدد أهداف يومية للفريق.",
        "شارك لقطات من حياة المتجر على إنستجرام.",
        "راقب الكلمات المفتاحية للبحث داخل المتجر.",
        "جرّب إرسال بريد دوري للعملاء.",
        "أنشئ مجتمع صغير حول البراند.",
        "اعرض زر تواصل سريع في كل صفحة.",
        "استخدم التنبيهات الذكية داخل النظام.",
        "أضف قسم 'موصى به لك'.",
        "تابع العملاء الجدد واحرص على رضاهم.",
        "قم بتحليل تراجع المبيعات عند حدوثه.",
        "حدث العروض بشكل دوري.",
        "احتفل بوصولك لإنجازات وشاركها.",
        "أضف خاصية تقييم المنتج بعد الشراء.",
        "استخدم Google Analytics لفهم جمهورك.",
        "أرسل رسالة شكر تلقائية بعد كل طلب.",
        "اعتمد على التوصيات الشخصية للمنتجات.",
        "اجعل السحب على جوائز جزء من حملاتك.",
        "استخدم الإحصائيات لعرض التقدم اليومي.",
        "استخدم روبوت دردشة لأسئلة الزوار.",
        "اجعل محتواك سهل المشاركة.",
        "أضف صفحة 'من نحن' بشرح صادق.",
        "شارك رحلة المنتج من المصنع للمستخدم.",
        "حلل أوقات التخلي عن السلة.",
        "تابع تنقلات المستخدم داخل التطبيق.",
        "جرّب أشكال متنوعة لعرض المنتجات.",
        "اعتمد سياسة شفافة في التعامل مع الأخطاء.",
        "استفد من تقييمات Google للعملاء.",
        "أنشئ دليل استخدام لبعض المنتجات.",
        "أضف حالة الطلب في الوقت الحقيقي."
    ];
    const index = new Date().getDate() % tips.length;
    setTip(tips[index]);
  }, []);

  const lowStock = products.filter(p => p.stock <= 2);
  const topSeller = [...products].sort((a, b) => a.stock - b.stock)[0];

  return (
    <>
      <div className="fixed bottom-6 left-6 z-50">
        <motion.button
          className="relative bg-primary p-4 rounded-full shadow-xl text-white hover:scale-110 transition"
          onClick={() => setOpen(true)}
          whileHover={{ rotate: [0, -5, 5, 0] }}
        >
          <Bot className="h-6 w-6" />
        </motion.button>
      </div>

      {open && (
        <motion.div
          initial={{ opacity: 0, y: 50 }}
          animate={{ opacity: 1, y: 0 }}
          className="fixed bottom-24 left-6 w-[350px] bg-white dark:bg-gray-900 rounded-xl shadow-xl p-4 z-50"
        >
          <div className="flex justify-between items-center mb-2">
            <h2 className="text-lg font-semibold flex items-center gap-2">
              <Smile className="w-5 h-5 text-yellow-500" /> مساعدك الذكي
            </h2>
            <Button variant="ghost" size="icon" onClick={() => setOpen(false)}>
              <X className="w-4 h-4" />
            </Button>
          </div>

          <div className="space-y-3 text-sm">
            <p>👋 صباح الخير! إليك تقرير اليوم:</p>

            {report && (
              <Card className="p-2 text-xs bg-accent">
                <p>إجمالي المبيعات: {report.sales}</p>
                <p>عدد الفواتير: {report.orders}</p>
                
              </Card>
            )}

            {topSeller && (
              <p>🔥 المنتج الأكثر مبيعًا: <strong>{topSeller.name}</strong></p>
            )}

            {lowStock.length > 0 && (
              <p className="text-red-500 flex items-start gap-1 flex-col">
                <span className="flex items-center gap-1">
                  <AlertTriangle className="w-4 h-4" />
                  منتجات على وشك النفاد: {lowStock.length}
                </span>
                <span className="pl-5 text-sm">
                  🔻 {lowStock[0].name}
                  {lowStock.length > 1 && ` والمزيد...`}
                </span>
              </p>
            )}

            {tip && (
              <p className="bg-muted px-3 py-2 rounded text-xs font-medium">💡 نصيحة اليوم: {tip}</p>
            )}
          </div>
        </motion.div>
      )}
    </>
  );
};

export default SmartAssistant;
